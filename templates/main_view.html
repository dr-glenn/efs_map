<!DOCTYPE HTML>

<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Ensemble Spaghetti</title>
    <script src='/efs_map/js/jquery-2.2.1.min.js'></script>
    <script src='/efs_map/js/utils.js'></script>
    <script src='/efs_map/js/efsm.js'></script>
    <script src='/efs_map/js/jquery.busy.min.js'></script>

    <link href="/efs_map/css/efs_map.css" rel="stylesheet" type="text/css"/>
    <link href="{{ fnmoc_css }}" rel="stylesheet" type="text/css"/>
    {{ tau_buttons_head }}
    {{ loop_control_head }}
<script type="text/javascript">
// TODO: this code should be generated by python or jinja2
function parse_fld_lvl(fld_lvl) {
    // Parse fld_lvl and fill other values
    // :param fld_lvl: string contains field name + underscore + level, e.g., wnd_850 or wnd_10
    // :return: 3 values: expanded field name, level type and level value
    // Example: wnd_850 expands to ['wnd_spd', 'isbr_lvl', '850']
    // Example: wnd_10 expands to ['wnd_spd', 'ht_sfc', '10']
    // NOTE: may not cover all possible fields, but is good enough for this application.
    var field, lvl_type, level0;
    var fld = fld_lvl.split('_');
    if (fld[0] == 'wnd') {
        field = 'wnd_spd';
        level0 = fld[1];
        if (fld[1] == '10') {
            lvl_type = 'ht_sfc';
        }
        else if (fld[1] == '850') {
            lvl_type = 'isbr_lvl';
        }
        else if (fld[1] == '250') {
            lvl_type = 'isbr_lvl';
        }
        else {
            // ERROR!
            alert('error 1');
        }
    }
    else if (fld[0] == 'temp') {
        field = 'air_temp';
        level0 = fld[1];
        if (fld[1] == '2') {
            lvl_type = 'ht_sfc';
        }
        else {
            // ERROR!
            alert('error 2');
        }
    }
    else if (fld[0] == 'prcp' || fld[0] == 'precip') {
        field = 'ttl_prcp_06';
        level0 = 0;
        lvl_type = 'surface';
    }
    else {
        // ERROR!
        alert('error 3');
    }
    jQuery('#myform input[name=lvl_type]').val(lvl_type);
    jQuery('#myform input[name=level0]').val(level0);
    jQuery('#myform input[name=field]').val(field);
    return [field,lvl_type,level0]
}

// Display the contour values in the form and return a string to use in img filenames
function set_contours() {
    var form_vals = jQuery('#myform').serialize();
    var str_contours = '';
    var contours;
    var override = jQuery('#contour_override').prop('checked');
    // Retrieve the contour values for the chosen field
    var qargs = 'action=contours&'+form_vals;
    jQuery.when(
        $.ajax( {url:"/efs_map/cgi-bin/efsm_query.py", data:qargs, type:"POST", dataType:"json",
            success: function(resp){
                //alert(JSON.stringify(resp));
                contours = resp['contours'];
            },
            error: function(xhr,status) {alert('contours: '+status);}
        })
    ).done(function(){
        var maxlen = contours.length;
        if (maxlen > 3) maxlen = 3;

        for (var i=0; i < maxlen; i++) {
            if (!override) jQuery('#contour'+(i+1)).val(f_format(contours[i],0));
            if (i > 0) str_contours += '-';
            str_contours += f_format(contours[i],0);
        }
    });
    return str_contours;
}

function update() {
    //alert('enter update');
    //loadBusy('#map_canvas');
    jQuery('#busy_img').show();
    // user clicked submit button, change DTG and field
    var dtg, fld_lvl;   // these are the visible fields in the form
    var lvl_type, level0, field, tau;   // these are hidden fields in the form
    //dtg = jQuery('#myform select[name=dtg]').val();
    //tau = jQuery('#myform input[name=tau]').val();
    fld_lvl = jQuery('#myform select[name=fld_lvl]').val();
    // Parse fld_lvl and fill other hidden values
    retval = parse_fld_lvl(fld_lvl);
    //field = retval[0];
    //lvl_type = retval[1];
    //level0 = retval[2];
    var form_vals = jQuery('#myform').serialize();
    //alert('form_vals = '+form_vals);
    set_contours();
    var url_img_base = '/efs_map/cgi-bin/efsm_img.py?map=spaghetti&'+form_vals;
    // Change IMG SRC of the visible map
    jQuery('#map_img').attr('src',url_img_base);
    var newurl = url_img_base.replace(/\&tau=\d/,'');
    // Change hidden IMG objects for all tau values
    {% for t in taus %}
        var map_id = '{{ "#map_%04d"%(t) }}';
        jQuery(map_id).attr('src',newurl+'&tau='+ {{ t }} );
    {% endfor %}
}

function clear_cache() {
    // remove all files in the server image cache directory
    var qargs = '?action=clear_cache';
    //alert(qargs);
    jQuery.ajax("/efs_map/cgi-bin/efsm_query.py"+qargs);
}

function disable_contour(id) {
    jQuery('#contour_override').prop('checked',false).trigger('change');
}

// contour override checkbox is toggled, change state of contour level boxes
function toggle_contour(id) {
    if (id.checked) {
        //jQuery('#contour1').prop("disabled", false);
        //jQuery('#contour2').prop("disabled", false);
        //jQuery('#contour3').prop("disabled", false);
        jQuery('input[name="contour[]"').prop("disabled", false);
    }
    else {
        //jQuery('#contour1').prop("disabled", true);
        //jQuery('#contour2').prop("disabled", true);
        //jQuery('#contour3').prop("disabled", true);
        jQuery('input[name="contour[]"').prop("disabled", true);
        set_contours();
    }
}
</script>
</head>

<body>
{{ classification_bar }}
{{ title_bar }}
<div class="container">
<div>
    <!-- selection controls and plume plot display area -->
    <form id="myform" class="control-box" action='javascript:update()'>
    <strong>Select field</strong><br/>
    <input name="lvl_type" type="hidden" value="ht_sfc">
    <input name="level0" type="hidden" value="2">
    <input name="field" type="hidden" value="air_temp">
    <select name="fld_lvl" onchange="javascript:disable_contour(this)">
        <option value="wnd_850">wind 850 mb</option>
        <option value="wnd_250">wind 250 mb</option>
        <option value="wnd_10">wind 10 m</option>
        <option value="temp_2">air-temp 2 m</option>
        <option value="prcp_06">precip 06</option>
    </select>
    <br>
    <input type="checkbox" id="contour_override" name="contour_override" onchange="javascript:toggle_contour(this)">
    <input type="text" name="contour[]" id="contour1" size="6" value="1">
        <input type="text" name="contour[]" id="contour2" size="6" value="2">
        <input type="text" name="contour[]" id="contour3" size="6" value="3">
    <br>
    <select name="dtg" id="dtg">
        {%  for dtg in dtgs %}
        <option value="{{ dtg }}">{{ dtg }}</option>
        {% endfor %}
    </select>
    <br/>
    <input type="radio" name="isis_dset" id="isis_dset_raw" value="raw" checked/><label for="isis_dset_raw">raw</label>
    <input type="radio" name="isis_dset" id="isis_dset_bc" value="bc" disabled/><label for="isis_dset_bc">bias-corrected</label>
    <input name="tau" type="hidden" value="0">
    <br>
    <input type="submit" value="Submit">
    </form>
    <br>
    {{ plume_form }}
    <img id="plume_img" alt="plume plot">
    <br>
    <button name="clear_cache" type="button" onclick="javascript:clear_cache()">Clear Cache</button>
</div>
<div>
    <!-- map with field displayed as spaghetti -->
    <div id="piano_keys" class="control-box" style="width:40%;margin:0 auto;">
    {{ piano_keys }}
    </div>
    <div id='canvas_div' style='position:relative; clear: both; width:800px; height:700px;'>
        <!-- busy_img requires z-index and position in order to overlay map images -->
        <img id='busy_img' src='/efs_map/images/lucy-busy.gif' alt='BUSY' style='position:relative; display:inline; z-index:10;'>
        <canvas id='map_canvas'></canvas>
        <canvas id='map_overlay'></canvas>
        <canvas id="map_zoom"></canvas>
        <img id='map_img' src='/efs_map/images/gears_animated.gif' alt='too bad' style='display:none;'>
        {% for tau in taus %}
            <img id='map_{{ "%04d"%(tau) }}' src='/efs_map/images/gears_animated.gif' alt='too bad' style='display:none;'>
        {% endfor %}
    </div>
</div>
<!-- use display:inline or none -->
<div style='display:inline'>
    <!-- useful debug displays of coordinate transformation tests -->
    <div id="xy_dbg" class="bordered"></div>
    <div id="plume_coord_dbg" class="bordered"></div>
</div>
</div>
<input type="hidden" name="img_scale" id="img_scale" value="2">
<input type="hidden" name="zoom_scale" id="zoom_scale" value="2">
<script type="text/javascript">
jQuery(document).ready( function() {
    loopControls.attachToTauButtons(tauButtons, "anim_speed");
    //jQuery('#contour_override').prop('checked',true);
    jQuery('#contour_override').prop('checked',false).trigger('change');
    //jQuery('#contour_override').trigger('change');
    //jQuery().busy("defaults", {img: "/efs_map/images/lucy-busy.gif"});
    update();   // load the page with all spaghetti maps
    jQuery("#map_canvas").mousedown(function(ev) {map_click(jQuery(this),ev);});    // set handler for mouse click within maps
    var img = document.getElementById('map_img');
    // override onload event for map_img - when loaded it will copy img to map_canvas
    img.onload = function(){
        var img_scale = parseFloat(document.getElementById('img_scale').value);
        var img_x = parseInt(this.width/img_scale);     // get size of map_img
        var img_y = parseInt(this.height/img_scale);
        // NOTE: could not get remaining code to work in jquery
        // Change size of canvas_div and map_canvas to match actual map_img
        console.log('x='+img_x+' y='+img_y);
        var c = document.getElementById("canvas_div");
        c.style.height = parseInt(img_y)+"px"; c.style.width = parseInt(img_x)+"px";
        c = document.getElementById("map_canvas");
        var ctx = c.getContext('2d');
        ctx.canvas.height = img_y; ctx.canvas.width  = img_x;
        ctx.drawImage(this,0,0,img_x,img_y);
        // Next line will draw lower-right quadrant of full map in window, if map_img has been scaled to 0.5
        //ctx.drawImage(this,-img_x,-img_y,2*img_x,2*img_y);
        // Now set the size of map_overlay - same as map_canvas
        c = document.getElementById("map_overlay");
        ctx = c.getContext('2d');
        ctx.canvas.height = img_y; ctx.canvas.width  = img_x;
        //loadNotBusy("#map_canvas");
        jQuery('#busy_img').hide();

    }
    //var mainImg = $("#map_img");
    //mainImg.load(function(){ loadNotBusy("#map_canvas"); } );
} );
</script>
{{ classification_bar }}
</body>
</html>
