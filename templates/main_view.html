<!DOCTYPE HTML>

<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <title>Ensemble Spaghetti</title>
    <script src='/efs_map/js/jquery-2.2.1.min.js'></script>
    <script src="/efs_map/js/ol-debug.js" type="text/javascript"></script>
    <script src='/efs_map/js/utils.js'></script>
    <script src='/efs_map/js/jquery.busy.min.js'></script>
    <link rel="stylesheet" href="/efs_map/css/ol.css" type="text/css">
    <style>
      .map {
        height: 600px;
        width: 800px;
      }
    </style>
    <script src='/efs_map/js/efsm.js'></script>
    <script src='/efs_map/js/efsm_ol3.js'></script>

    <link href="/efs_map/css/efs_map.css" rel="stylesheet" type="text/css"/>
    <link href="{{ fnmoc_css }}" rel="stylesheet" type="text/css"/>
    {{ tau_buttons_head }}
    {{ loop_control_head }}
<script type="text/javascript">
// TODO: this code should be generated by python or jinja2
function parse_fld_lvl(fld_lvl) {
    // Parse fld_lvl and fill other values
    // :param fld_lvl: string contains field name + underscore + level, e.g., wnd_850 or wnd_10
    // :return: 3 values: expanded field name, level type and level value
    // Example: wnd_850 expands to ['wnd_spd', 'isbr_lvl', '850']
    // Example: wnd_10 expands to ['wnd_spd', 'ht_sfc', '10']
    // NOTE: may not cover all possible fields, but is good enough for this application.
    var field, lvl_type, level0;
    var fld = fld_lvl.split('_');
    if (fld[0] == 'wnd') {
        field = 'wnd_spd';
        level0 = fld[1];
        if (fld[1] == '10') {
            lvl_type = 'ht_sfc';
        }
        else if (fld[1] == '850') {
            lvl_type = 'isbr_lvl';
        }
        else if (fld[1] == '250') {
            lvl_type = 'isbr_lvl';
        }
        else {
            // ERROR!
            alert('error 1');
        }
    }
    else if (fld[0] == 'temp') {
        field = 'air_temp';
        level0 = fld[1];
        if (fld[1] == '2') {
            lvl_type = 'ht_sfc';
        }
        else {
            // ERROR!
            alert('error 2');
        }
    }
    else if (fld[0] == 'prcp' || fld[0] == 'precip') {
        field = 'ttl_prcp_06';
        level0 = 0;
        lvl_type = 'surface';
    }
    else {
        // ERROR!
        alert('error 3');
    }
    jQuery('#myform input[name=lvl_type]').val(lvl_type);
    jQuery('#myform input[name=level0]').val(level0);
    jQuery('#myform input[name=field]').val(field);
    return [field,lvl_type,level0]
}

// Display the contour values in the form and return a string to use in img filenames.
// If override checkbox is false, then default values are retrieved from python server code.
// If override checkbox is true, then python server code needs these new numbers.
// In either case, the server returns the default values.
function set_contours() {
    var form_vals = jQuery('#myform').serialize();
    var str_contours = '';
    var contours = [1,2,3];
    var override = jQuery('#contour_override').prop('checked');
    // Retrieve the contour values for the chosen field
    var qargs = 'action=contours&'+form_vals;
    // Send contour values to server, but server obeys override checkbox.
    jQuery.when(
        $.ajax( {url:"/efs_map/cgi-bin/efsm_query.py", data:qargs, type:"POST", dataType:"json",
            success: function(resp){
                //alert(JSON.stringify(resp));
                contours = resp['contours'];
            },
            error: function(xhr,status) {alert('contours: '+status);}
        })
    ).done(function(){
        // TODO: want to return 'contours' from this function and THEN call create_legend.
        var maxlen = contours.length;
        if (maxlen > 3) maxlen = 3;

        var curr_contour;
        var curr_contours = [];
        for (var i=0; i < maxlen; i++) {
            // If override is false, then update the form values with numbers from server
            if (!override) jQuery('#contour'+(i+1)).val(f_format(contours[i],0));
            curr_contour = jQuery('#contour'+(i+1)).val();  // fetch the current form value
            curr_contours.push(curr_contour);
            if (i > 0) str_contours += '-';
            str_contours += f_format(curr_contour,0);
        }
        //console.log('set_contours: '+JSON.stringify(curr_contours));
        create_legend(curr_contours);    // Really wish I could make set_contours be synchronous function.
    });
}

function update() {
    //alert('enter update');
    jQuery('#busy_img').show();
    // user clicked submit button, change DTG and field
    var dtg, fld_lvl;   // these are the visible fields in the form
    var lvl_type, level0, field, tau;   // these are hidden fields in the form
    //dtg = jQuery('#myform select[name=dtg]').val();
    //tau = jQuery('#myform input[name=tau]').val();
    fld_lvl = jQuery('#myform select[name=fld_lvl]').val();
    // Parse fld_lvl and fill other hidden values
    retval = parse_fld_lvl(fld_lvl);
    //field = retval[0];
    //lvl_type = retval[1];
    //level0 = retval[2];
    var form_vals = jQuery('#myform').serialize();
    //alert('form_vals = '+form_vals);
    var new_contours = set_contours();
    //create_legend(['10','20','30']);
    //console.log('contours: '+JSON.stringify(new_contours));
    //create_legend(new_contours);
    var url_img_base = '/efs_map/cgi-bin/efsm_img.py?map=spaghetti&'+form_vals;
    // Change IMG SRC of the visible map
    jQuery('#map_img').attr('src',url_img_base);
    var newurl = url_img_base.replace(/\&tau=\d/,'');
    // Change hidden IMG objects for all tau values
    {% for t in taus %}
        var map_id = '{{ "#map_%04d"%(t) }}';
        jQuery(map_id).attr('src',newurl+'&tau='+ {{ t }} );
    {% endfor %}
}

function clear_cache() {
    // remove all files in the server image cache directory
    var qargs = '?action=clear_cache';
    //alert(qargs);
    jQuery.ajax("/efs_map/cgi-bin/efsm_query.py"+qargs);
}

function disable_contour(id) {
    jQuery('#contour_override').prop('checked',false).trigger('change');
}

// contour override checkbox is toggled, change state of contour level boxes
function toggle_contour(id) {
    if (id.checked) {
        //jQuery('#contour1').prop("disabled", false);
        //jQuery('#contour2').prop("disabled", false);
        //jQuery('#contour3').prop("disabled", false);
        jQuery('input[name="contour[]"').prop("disabled", false);
    }
    else {
        //jQuery('#contour1').prop("disabled", true);
        //jQuery('#contour2').prop("disabled", true);
        //jQuery('#contour3').prop("disabled", true);
        jQuery('input[name="contour[]"').prop("disabled", true);
        set_contours();
    }
}
</script>
</head>

<body>
{{ classification_bar }}
{{ title_bar }}
<div class="my-container">
<div class="flex-item">
    <!-- selection controls and plume plot display area -->
    <form id="myform" class="control-box" action='javascript:update()'>
    <strong>Select field</strong><br/>
    <input name="lvl_type" type="hidden" value="ht_sfc">
    <input name="level0" type="hidden" value="2">
    <input name="field" type="hidden" value="air_temp">
    <select name="fld_lvl" onchange="javascript:disable_contour(this)">
        <option value="wnd_850">wind 850 mb</option>
        <option value="wnd_250">wind 250 mb</option>
        <option value="wnd_10">wind 10 m</option>
        <option value="temp_2">air-temp 2 m</option>
        <option value="prcp_06">precip 06</option>
    </select>
    <br>
    <input type="checkbox" id="contour_override" name="contour_override" onchange="javascript:toggle_contour(this)">
    <input type="text" name="contour[]" id="contour1" size="6" value="1">
        <input type="text" name="contour[]" id="contour2" size="6" value="2">
        <input type="text" name="contour[]" id="contour3" size="6" value="3">
    <br>
    <select name="dtg" id="dtg">
        {%  for dtg in dtgs %}
        <option value="{{ dtg }}">{{ dtg }}</option>
        {% endfor %}
    </select>
    <br/>
    <input type="radio" name="isis_dset" id="isis_dset_raw" value="raw" checked/><label for="isis_dset_raw">raw</label>
    <input type="radio" name="isis_dset" id="isis_dset_bc" value="bc" disabled/><label for="isis_dset_bc">bias-corrected</label>
    <input name="tau" type="hidden" value="0">
    <br>
    <input type="submit" value="Submit">
    </form>
    <br>
    {{ plume_form }}
    <img id="plume_img" alt="plume plot">
    <br>
    <button name="clear_cache" type="button" onclick="javascript:clear_cache()">Clear Cache</button>
</div>
<div class="flex-item">
    <!-- map with field displayed as spaghetti -->
    <div id="legend_div" style='display:inline-block'></div>
    <div id="piano_keys" class="control-box" style="width:40%;margin:0 auto;display:inline-block;">
    {{ piano_keys }}
    </div>
    <!-- mouse-position div might not be used, but will leave it for future -->
    <div id="mouse-position" style='display:inline-block'></div>
    <div id='canvas_div' style='position:relative; clear: both; width:800px; height:700px;'>
        <!-- busy_img requires z-index and position in order to overlay map images -->
        <img id='busy_img' src='/efs_map/images/lucy-busy.gif' alt='BUSY' style='position:relative; display:inline; z-index:10;'>
        <div id="map_div"></div>
        <img id='map_img' src='/efs_map/images/gears_animated.gif' alt='too bad' style='display:none;'>
        {% for tau in taus %}
            <img id='map_{{ "%04d"%(tau) }}' src='/efs_map/images/gears_animated.gif' alt='missing {{ "%04d"%(tau) }}' style='display:none;'>
        {% endfor %}
    </div>
</div>
<script type="text/javascript">
    // TODO: for some reason this code will not work when inside jQuery.ready()
    var ll_proj = 'EPSG:4326';  // with 3857 the map looks the same, but coords are in meters
    var map = create_main_map();
</script>
<!-- use display:inline or none -->
<div class="flex-item">
    <!-- useful debug displays of coordinate transformation tests -->
    <div id="xy_dbg" class="bordered"></div>
    <div id="plume_coord_dbg" class="bordered"></div>
</div>
</div>
<input type="hidden" name="img_scale" id="img_scale" value="2">
<input type="hidden" name="zoom_scale" id="zoom_scale" value="2">
<script type="text/javascript">
jQuery( function() {
    loopControls.attachToTauButtons(tauButtons, "anim_speed");
    jQuery('#contour_override').prop('checked',false).trigger('change');
    //jQuery().busy("defaults", {img: "/efs_map/images/lucy-busy.gif"});
    update();   // load the page with all spaghetti maps
    var img = document.getElementById('map_img');
    //
    img.onload = function(){
        var img_scale = parseFloat(document.getElementById('img_scale').value);
        var img_x = parseInt(this.width/img_scale);     // get size of map_img
        var img_y = parseInt(this.height/img_scale);
        // NOTE: could not get remaining code to work in jquery
        // Change size of canvas_div and map_canvas to match actual map_img
        console.log('x='+img_x+' y='+img_y);
        // should use map_div for size of canvas_div
        var map_x = jQuery('#map_div').width();
        var map_y = jQuery('#map_div').height();
        var c = document.getElementById("canvas_div");
        //c.style.height = parseInt(img_y)+"px"; c.style.width = parseInt(img_x)+"px";
        c.style.height = parseInt(map_y)+"px"; c.style.width = parseInt(map_x)+"px";
        jQuery('#busy_img').hide();
        lyr=map.getLayers().getArray()[1];
        new_source = new ol.source.ImageStatic({
            attributions: 'this is an attribution',
            url: img.src,
            projection: ll_proj,
            imageExtent: ll_extent,
        });
        lyr.setSource(new_source);

    }
} );
</script>
{{ classification_bar }}
</body>
</html>
